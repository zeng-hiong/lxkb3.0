<!DOCTYPE html>
<html lang="zh-cmn-Hans" class="">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<meta name="keywords" content="">
		<meta name="description" content="">
		<meta name="x5-orientation" content="portrait">
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="screen-orientation" content="portrait">
		<meta http-equiv="Cache-Control" content="no-cache">
		<link rel="stylesheet" href="css/common.css">
		<link rel="stylesheet" type="text/css" href="css/mui.css"/>
		<script src="js/common.js" type="text/javascript" charset="utf-8"></script>
		<style>
			 .mui-input-group .mui-input-row:after{height:0}
		</style>
	</head>
	<body >
		<header class="mui-bar mui-bar-nav">
	       <h1 class="mui-title">我要收款</h1>
	       <button class="mui-action-back-mui-btn mui-btn-link mui-btn-nav mui-pull-left">
	       	  <span class="mui-icon mui-icon-left-nav"></span>返回
	       </button>
     </header>
     <div class="mui-content">
        <div class="mui-input-group" id="selectCardArea">
	   	    <div class="mui-input-row">
	       	   <label for="">选择卡片:</label>
	       	   <div style='height: 50px;line-height: 50px;text-indent: -15px;'>
		       	   	<img src="image/bankicon/blank.png" class="bankimg" style='margin-right: 0;' alt="" />
		       	   	<span>请选择银行卡</span>
	       	   </div>
	       	   <span class="mui-icon mui-icon-arrowright"></span>
	        </div>
	   	</div>
	   	<p class='paddinglf' style="margin:5px 0;padding-left: 15px;">请输入收款金额</p>
	   	<div class="mui-input-group marginbtm">
	        <div class="mui-input-row">
	       	  <label for="">收款金额:</label>
	       	  <div style='height: 50px;line-height: 50px;'>
		       	   	<span><span id="gathmoney">0.00</span>元</span>
	       	   </div>
	        </div>
	         <div style='font-size: 0.24rem;color:#999;padding:0 15px 0.1rem'>收款金额在100元~20000元之间</div>
	   	</div>
          	<!--金额输入键盘-->
          	<div id="calculator" class="mui-hidde">
				<table>
					<tbody>
						<tr>
							<td>1</td>
							<td>2</td>
							<td>3</td>
							<td class='del'><img src="image/btn_del_compute.png" alt="" /></td>
						</tr>
						<tr>
							<td>4</td>
							<td>5</td>
							<td>6</td>
							<td rowspan="3" class='makesure'>确认<br/>收款</td>
						</tr>
						<tr>
							<td>7</td>
							<td>8</td>
							<td>9</td>
						</tr>
						<tr>
							<td>00</td>
							<td>0</td>
							<td>.</td>
						</tr>
					</tbody>
				</table>
			</div>
			<!-- 支付密码输入框 -->
          	<div id="paypassword" class="mui-hidden">
				<div style=''>
					<p style='border:none'>输入支付密码</p>
                    <p style='font-size:0.24rem;color:#999;padding-top:0'>到账银行卡：<span>平安银行储蓄卡</span><span style='padding:0 0.2rem'>(5683)</span>手续费2元/笔</p>
					<div class="pwd-box" style='position:relative;'>
						<div class="pwd-input" id="pwd-input"></div>
						<div class="fake-box">
							<input type="password" readonly="" value="" />
							<input type="password" readonly="" value="" />
							<input type="password" readonly="" value="" />
							<input type="password" readonly="" value="" />
							<input type="password" readonly="" value="" />
							<input type="password" readonly="" value="" />
						</div>
					</div>
					<a href='forgetpassword.html' id="forgetpwd" style="color:#309bdf;text-align:right;padding:0.2rem 1rem 0.2rem 0">忘记密码？</a>
					<table id='pswnum'>
						<tbody>
							<tr>
								<td class='numb'>1</td>
								<td class='numb'>2</td>
								<td class='numb'>3</td>
							</tr>
							<tr>
								<td class='numb'>4</td>
								<td class='numb'>5</td>
								<td class='numb'>6</td>
							</tr>
							<tr>
								<td class='numb'>7</td>
								<td class='numb'>8</td>
								<td class='numb'>9</td>
							</tr>
							<tr>
								<td class='empty'></td>
								<td class='numb'>0</td>
								<td class='delt'><img src="image/btn_del_code.png" alt="" /></td>
							</tr>
						</tbody>
					</table>
				</div>
		   </div>
           <div class="choosecard mui-scroll-wrapper" style='display: none;'>
           	  <div class="mui-scroll">
	              <p class="aligncenter"><span class="abvt">取消</span>选择银行卡</p>
	              <div class="formbox">
	                 <!--<div>
	                      <img src="image/icon_bank_logo_pa.png" alt="" width="28" />
	                      <label for="999">
	                         <span>平安银行<span class="cardtype">(信用卡)</span></span>
	                         <span>尾号2333</span>
	                      </label>
	                     <input type="radio" value="233" name="2233" checked="checked" />
	                </div>
	                 <div>
	                      <img src="image/icon_bank_logo_pa.png" alt="" width="28" />
	                      <label for="999">
	                         <span>平安银行<span class="cardtype">(信用卡)</span></span>
	                         <span>尾号2333</span>
	                      </label>
	                     <input type="radio" value="233" name="2233" checked="checked" />
	                </div>
	                 <div>
	                      <img src="image/icon_bank_logo_pa.png" alt="" width="28" />
	                      <label for="999">
	                         <span>平安银行<span class="cardtype">(信用卡)</span></span>
	                         <span>尾号2333</span>
	                      </label>
	                     <input type="radio" value="233" name="2233" checked="checked" />
	                </div>
	                 <div>
	                      <img src="image/icon_bank_logo_pa.png" alt="" width="28" />
	                      <label for="999">
	                         <span>平安银行<span class="cardtype">(信用卡)</span></span>
	                         <span>尾号2333</span>
	                      </label>
	                     <input type="radio" value="233" name="2233" checked="checked" />
	                </div>
	                 <div>
	                      <img src="image/icon_bank_logo_pa.png" alt="" width="28" />
	                      <label for="999">
	                         <span>平安银行<span class="cardtype">(信用卡)</span></span>
	                         <span>尾号2333</span>
	                      </label>
	                     <input type="radio" value="233" name="2233" checked="checked" />
	                </div>
	                 <div>
	                      <img src="image/icon_bank_logo_pa.png" alt="" width="28" />
	                      <label for="999">
	                         <span>平安银行<span class="cardtype">(信用卡)</span></span>
	                         <span>尾号2333</span>
	                      </label>
	                     <input type="radio" value="233" name="2233" checked="checked" />
	                </div>
	                 <div>
	                      <img src="image/icon_bank_logo_pa.png" alt="" width="28" />
	                      <label for="999">
	                         <span>平安银行<span class="cardtype">(信用卡)</span></span>
	                         <span>尾号2333</span>
	                      </label>
	                     <input type="radio" value="233" name="2233" checked="checked" />
	                </div>
	                 <div>
	                      <img src="image/icon_bank_logo_pa.png" alt="" width="28" />
	                      <label for="999">
	                         <span>平安银行<span class="cardtype">(信用卡)</span></span>
	                         <span>尾号2333</span>
	                      </label>
	                     <input type="radio" value="233" name="2233" checked="checked" />
	                </div>
	                <div>
		                <img src="image/icon_bank_logo_pa.png" width="28 alt=" />
		                <label for="3344">
		                   <span>平安银行<span class="cardtype">(信用卡)</span></span>
		                   <span>尾号2333</span>
		                </label>
		                <input type="radio" value="22" name="2233" />
	                </div>
	                  <div>
	                     <img src="image/icon_bank_logo_pa.png" alt="" width="28" />
	                     <label for="2233">
	                       <span>中国银行<span class="cardtype">(储蓄卡)</span></span>
	                       <span>尾号5511</span>
	                     </label>
	                     <input type="radio" value="2233"  name="2233" />
	                </div>-->
	                <div id="addCard">
	                   <a href="addCreditcard.html"><img src="image/icon_add.png" alt="" width="28" />添加信用卡</a>
	                </div>
	             </div>
            </div>
          </div>
        </div>
     </div>
	</body>
	<script src='js/jquery-2.0.0.min.js'></script>
	<script type="text/javascript " src="js/mui.min.js "></script>
	<script type="text/javascript" src="js/app.js" ></script>
	<script type="text/javascript" src="js/security.js" ></script>
	<script>
		$(document).ready(function(){
			$('td').on('touchstart', function() {
				 $(this).css('background','#b4e7ff');
			});
			
			$('td').on('touchend', function() {
				 $(this).css('background', '');  //去除背景色
			});
		});
		
		mui("body").on("tap", "button.mui-action-back-mui-btn", backWin);
		function backWin() {
		  	plus.webview.currentWebview().close();
		}
		
		mui.plusReady(function() {
			initCardList();
		});
		
		$("#forgetpwd").on('touchend', function(e) {
			app.openWindow("setupdatepaypassword.html","setupdatepaypassword.html");
		});
		
		$('.choosecard>p .abslt').on('touchend', function(e) {
			initKeyboard();
			e.stopPropagation();
			return false;
		});
		
		window.addEventListener("getCreditCard", function(e){
			initCardList();
		});
		
		var cardSN = null;
		function initCardList() {
			var para = {"CARD_TYPE" : 1};
			app.getData("/account/get_card_list.do", para, function(data) {
				console.log(JSON.stringify(data));
				var list = data.RESULT_OBJECT;
				if(list && list.length > 0) {
					var html = [];
					for(var i = 0; i < data.RESULT_OBJECT.length; i++) {
						var bankMap = data.RESULT_OBJECT[i];
						if(bankMap.CHANNEL_ID == 1) {
							html.push("<div>");
							html.push("	<img src='" + bankMap.BANK_ICON + "' alt=''  width='28' />");
							html.push("	<label for='BANK_ID" + bankMap.BANK_ID + "'>");
							html.push("		<span>" + bankMap.BANK_NAME + "<span class='cardtype'>(" + bankMap.CARD_TYPE_DESC + ")</span></span>");
							html.push("		<span>尾号" + bankMap.CARD_NO.match(/\d{4}$/) + "</span>");
							html.push("	</label>");
							html.push("	<input type='radio' name='bankna' id='BANK_ID" + bankMap.BANK_ID + "' value='" + bankMap.CARD_SN + "' />");
							html.push("</div>");
						}
						
					}
					
					var container = $(".choosecard .formbox");
					$("div:last", container).siblings().remove();
					container.prepend(html.join(""));
					
					mui(".choosecard .formbox").on('tap','div:not(:last-of-type)',function(e) {
						$(".choosecard .formbox input:checked").prop("checked", false);
						var input = $("input", this);
						input.prop("checked", true);
						
						var src = input.siblings("img").attr("src");
						var html= input.siblings('label').html();
						
						$("#selectCardArea img").attr("src", src).siblings("span").html(html);
						cardSN = input.val();
						console.log(cardSN);
						
						initKeyboard();
					});
					//$(".choosecard .formbox div:first").trigger("touchend");
				}
			});
		}
		
		function initKeyboard() {
			$('.choosecard').slideUp(500);  //隐藏银行卡列表
			$("#calculator").slideDown(500);
			
			hidePaymentPassword();
		}
		
		function hidePaymentPassword() {
			$('#paypassword').fadeOut(100);
			$('.fake-box input').val('');
			$('#pwd-input').text('');
		}
		
		$('#paypassword > div').on('touchend', function(e){
			e.stopPropagation();
		});
		
		//$("body").on("touchend", function(e) {
		//	initKeyboard();
		//	e.stopPropagation();
		//	return false;
		//});
		
		/**
		 * 选择银行卡列表界面，取消按钮事件绑定
		 */
		$(".choosecard .abvt").on('touchend', function(e){
			initKeyboard();
		});
		
		$('#paypassword .arrow').on('touchend', function(e) {
		});
		
		//调出选择卡列表
		$('#selectCardArea').on('touchend', function(e) {
			
			var height2=$('.choosecard').height();
			
			$('.choosecard').slideToggle(500);
			$("#calculator").slideToggle(500);
			var height1=$('.formbox').height();
			
			if(height1-height2>20){
				 $('.choosecard .mui-scroll').css('bottom','initial');
				 console.log('hello world')
			}
			
			e.stopPropagation();
			return false;
		});
		
		/*$(".choosecard").on("touchend", function(e) {
			e.stopPropagation();
			return false;
		});*/
		
		$("#calculator td").on("touchend", function(e) {
			var _self = $(this);
			var index = _self.index();
			var text = _self.text();
			var amount = $('#gathmoney');
			if(_self.hasClass("del")) {
				var tmp = amount.html();
				
				if(tmp != "0.00") {
					amount.html(tmp.substring(0, tmp.length - 1));
					if(amount.html() == "") amount.html("0.00");
				}
			} else if(_self.hasClass("makesure")) {
				if(cardSN == null) {
					mui.toast("请选择要收款的银行卡");
					e.stopPropagation();
					return false;
				}
				
				if(amount.html() == "0.00") {
					mui.toast("请输入收款金额");
					e.stopPropagation();
					return false;
				} else if(isNaN(amount.text())) {
					mui.toast("无效的收款金额");
					e.stopPropagation();
					return false;
				}
				if(parseInt(amount.text()) < 100 || parseInt(amount.text()) > 20000) {
					mui.toast("收款金额在100-20000元之间");
					e.stopPropagation();
					return false;
				}
				
				mui.openWindow({
					id: "choosePassway.html",
					url: "choosePassway.html",
					show: {
						aniShow: 'slide-in-right',
						duration: 250,
					},
					waiting: {
						autoShow: false,
						title: '正在加载。。。'
					},
					extras: {
						AMOUNT: amount.text(),
						BANK_ICON: $("#selectCardArea img").attr("src"),
						BANK_NAME: $("#selectCardArea img").siblings("span").html(),
						CARD_SN: cardSN
					}
				});
				
				//$("#calculator").slideToggle(500);
				//$('#paypassword').slideToggle(500);  //调出密码键盘
				
			} else {
				if(amount.html() == "0.00") {
					if(text == "0" || text == "00" || text == ".") {
						e.stopPropagation();
						return false;
					}
					amount.html("");
				}
				
				var arr = amount.html().split(".");
				if(arr.length == 2 && arr[1].length >= 2) {
					text = "";
				}
				amount.html(amount.html() + text);
			}
			
			console.log("idx:" + index + ",text:" + text);
			e.stopPropagation();
			return false;
		});
		
		
		$("#addCard").on("touchend", function(e) {
			var url = $("a", this).attr('href');
			mui.openWindow({
				id: url,
				url: url,
				show: {
					aniShow: 'slide-in-right',
					duration: 250,
				},
				waiting: {
					autoShow: false,
					title: '正在加载。。。'
				},
				extras: {}
			});
			
			e.stopPropagation();
			return false;
		});
		
		$('#pswnum').on('touchend', '.delt', function(e) {
			var passwordBox = $('#pwd-input');
			var tmp = passwordBox.text().trim();
			passwordBox.html(tmp.substring(0, tmp.length - 1));
			for(var i = 0; i < 6; i++) {
				$('.fake-box input').eq(i).val(passwordBox.text().length > i ? "0" : "");
			}
		});
		
		$('#pswnum').on('touchend', '.numb', function(e) {
			var _self = $(this);
			var text = _self.text();
			var passwordBox = $('#pwd-input');
			if(passwordBox.text().trim().length < 6) {
				passwordBox.html(passwordBox.html() + text);
				for(var i = 0; i < passwordBox.text().trim().length; i++) {
					$('.fake-box input').eq(i).val(i);
				}
				
				if(passwordBox.text().trim().length == 6) {
					//plus.device.vibrate(500);
					callPay(cardSN, passwordBox.html(), $('#gathmoney').html());
					hidePaymentPassword();
				}
			}
			e.stopPropagation();
			return false;
		});
		
		function callPay(cardSN, payPwd, amount) {
			plus.nativeUI.showWaiting();
			var para = {
				CARD_SN: cardSN,
				PAY_PWD: RSAUtils.encryptedString(payPwd), 
				AMOUNT: amount};
			
			app.getData("/account/receivables.do", para, function(data) {
				plus.nativeUI.closeWaiting();
				if(data.RESULT_CODE == 0) {
					plus.nativeUI.alert("收款成功", function(e) {
						//$('#gathmoney').html("0.00");
						plus.webview.currentWebview().close();
					});
					//mui.toast("收款成功");
				}
			});
		}
		
		mui('.mui-scroll-wrapper').scroll();
		if($('.formbox').height()-$('.choosecard').height()>20){
			 $('.choosecard .mui-scroll').css('bottom','initial');
		}
		  mui.prompt('请输入你对MUI的评语：', '性能好', 'Hello MUI', btnArray, function(e) {
                    if (e.index == 1) {
                        info.innerText = '谢谢你的评语：' + e.value;
                    } else {
                        info.innerText = '你点了取消按钮';
                    }
                })
	</script>

</html>